{% extends "general/bases/base_content.html" %}
{% load static %}
{% block header %}
{% include "roboadvisor/header/details.html" %}
<script src="https://unpkg.com/htmx.org@1.7.0" 
    integrity="sha384-EzBXYPt0/T6gxNp0nuPtLkmRpmDBbjg6WmCUZRLXBBwYYmwAUxzlSGej0ARHX0Bo" 
    crossorigin="anonymous" defer></script>

  <!-- static/general/assets/vendor/js-cookie -->
{% endblock header%}

{% block FirstCtaContent %}
{% include "roboadvisor/complements/details.html" %}
{% endblock FirstCtaContent %}

{% block FirstContent %}
<!-- {% include "public_blog/complements/first_content.html" %} -->
{% endblock FirstContent%}

{% block ListContent %}
<style>
    .fondo-wait{
      display: none;
    }
  
    .fondo-wait.activo {
      display: block;
      background: rgba(148, 148, 148, 0.508);
      position: fixed;
      z-index: 99;
      width: 100vw;
      height: 100vh;
      top: 0;
      left: 0;
  }
  
  .loader{
    display: none;
  }
  .loader.activo {
    display: block;
    position: absolute;
    left: 50%;
    top: 120%;
    z-index: 100;
    width: 120px;
    height: 120px;
    margin: -76px 0 0 -76px;
    border: 16px solid #f3f3f3;
    border-radius: 50%;
    border-top: 16px solid #1e7929;
    -webkit-animation: spin 2s linear infinite;
    animation: spin 2s linear infinite;
  }
   /* Safari */
   @-webkit-keyframes spin {
    0% { -webkit-transform: rotate(0deg); }
    100% { -webkit-transform: rotate(360deg); }
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% with steps=service.steps.all %}
{% with total_steps=steps|length %}
<div class="col-12">
{% for step in steps %}
    {% with current_step=forloop.counter0 %}
    {% url step.url as the_url %}
    {% with order=step.order|slugify %}
    {% with fieldclass="form-step-"|add:order|add:" form-control" %}
    
    <div class="card"
        style="position: absolute; display:{% if not forloop.first %}none{% else %}inline{% endif %};"
        id="part-{{current_step}}">
        <div class="card-header">
            {{ step.title }}
        </div>
        <div class="card-body">
            <div class="card-text">
                {{ step.description }}
            </div>
        </div>
        {% include "roboadvisor/forms/activity.html" %}
        <div class="card-body">
            <div class="card-text">
                {% include step.template_path %}
            </div>
            <div class="text-center">
                <div class="alert alert-danger" id="faltante-{{step.order}}" role="alert" style="display: none;">
                    Rellena todos los campos correctamente
                </div>
            </div>            
        </div>
        <div class="card-footer">
            <div class="clearfix">
                <div class="float-start">
                    {% if not forloop.first %}
                    <button class="btn btn-primary btn-sm" onclick="ShowPrevStep({{current_step}})">Anterior</button>
                    {% endif %}
                </div>
                <div class="float-end">
                    {% if forloop.last %}
                    <button class="btn btn-primary btn-sm" onclick="FinalizeTest({{current_step}}, '{{the_url}}')">Finalizar</button>                                                    
                    {% else %}
                    <button class="btn btn-primary btn-sm" onclick="ShowNextStep({{current_step}}, '{{the_url}}')">Siguiente</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    {% endwith %}
    {% endwith %}
    {% endwith %}
{% endfor %}
</div>
{% endwith %}
{% endwith %}
<div class="fondo-wait" id="fondo-wait" ></div>
<div class="loader" id="loader"></div>
{% endblock ListContent %}

{% block MiddleCtaContent %}
<!-- {% include "public_blog/cta/inicio_middle.html" %} -->
{% endblock MiddleCtaContent %}

{% block javascript %}
    {{ block.super }}
    <!-- 
        Probar si el csrf token se genera siempre
        Ver como indicar qué form se ha creado. Quizás poner el id de la repuesta en cookies
        con un atributo "creado", si js encuentra este atributo hacer un update en la view.
        Quizás manejarlo desde las sessions.
        Track el inicio del test y la finalización. Si el test no ha terminado mandar recordatorio
     -->
    <script>
        function SendData(step, url){
            var dataFields = document.getElementsByClassName('form-step-' + step.toString())
            
            var formData = {};
            for (const s of dataFields){
                console.log(s.value)
                formData[s.name] = s.value
            }
            // console.log(Cookies.get('cookie'))
            console.log(formData)
            event.preventDefault();
            $.ajax({
                url: url,
                type: "POST",
                dataType: "json",
                data: formData,
                headers: {
                "X-Requested-With": "XMLHttpRequest",
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                
                },
                success: (data) => {
                },
            
            });
        }

        function FinalizeTest(step, url){
            var validation = ValidateData(step)
            if (validation) {
                document.getElementById('fondo-wait').classList.add('activo');
                document.getElementById('loader').classList.add('activo');
                return SendData(step, url)
            }
        }

        function ValidateData(step){
            var dataFields = document.getElementsByClassName('form-step-' + step.toString())
            for (const s of dataFields) {
                if (s.value==''){
                    document.getElementById("faltante-" + step.toString()).style.display = 'inline';
                    return false
                }
            }
            return true
        }

        function ShowStep(stepsDict){
            var currentCard = document.getElementById("part-" + stepsDict.current.toString());
            var selCard = document.getElementById("part-" + stepsDict.sel.toString());
            currentCard.style.display = "none";
            selCard.style.display = "inline";
        }

        function ShowPrevStep(step){
            document.getElementById("faltante-" + step.toString()).style.display = 'none';
            var selStep = step - 1
            var stepsDict = {
                'current':step,
                'sel':selStep
            }
            return ShowStep(stepsDict)
        }

        function ShowNextStep(step, url){
            var validation = ValidateData(step)
            if (validation) {
                document.getElementById("faltante-" + step.toString()).style.display = 'none';
                var selStep = step + 1
                var stepsDict = {
                    'current':step,
                    'sel':selStep
                }
                SendData(step, url)
                return ShowStep(stepsDict)
            }            
        }
    </script>
{% endblock %}
